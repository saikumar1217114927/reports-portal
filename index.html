<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>File Portal ‚Äî Login + File List</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--white:#e6eef6}
    body{font-family:Inter,ui-sans-serif,system-ui,Arial;background:linear-gradient(180deg,#07101a, #081826);color:var(--white);min-height:100vh;margin:0;display:flex;align-items:center;justify-content:center;padding:24px}
    .wrap{width:100%;max-width:980px;background:var(--card);border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,.6);padding:20px;display:grid;grid-template-columns:340px 1fr;gap:20px}
    h1{margin:0 0 10px 0;font-size:20px}
    label{display:block;font-size:13px;color:var(--muted);margin-top:12px}
    input[type=text],input[type=password],input[type=email]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.02);color:var(--white)}
    button{margin-top:14px;padding:10px 12px;border-radius:8px;border:0;background:var(--accent);color:#022;cursor:pointer;font-weight:600}
    .small{font-size:13px;color:var(--muted);margin-top:10px}
    .files{padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));height:560px;overflow:auto}
    .search{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .file{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.03);display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .folder{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.03);display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;background:rgba(6,182,212,.1)}
    .folder:hover{cursor:pointer;background:rgba(6,182,212,.2)}
    .meta{font-size:13px;color:var(--muted)}
    .actions a{padding:6px 8px;border-radius:6px;background:rgba(255,255,255,.03);text-decoration:none;color:var(--white);font-size:13px}
    .top-actions{display:flex;gap:8px;align-items:center}
    .breadcrumb{margin-bottom:12px;padding:8px;border-radius:8px;background:rgba(255,255,255,.02)}
    .breadcrumb span{margin:0 4px;cursor:pointer;color:var(--accent)}
    .breadcrumb span:hover{text-decoration:underline}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}
    .session-timer{display:flex;align-items:center;gap:8px;margin:8px 0;font-size:12px;color:var(--muted)}
    .session-bar{background:rgba(255,255,255,.1);height:4px;border-radius:2px;overflow:hidden;margin-top:4px}
    .session-progress{background:var(--accent);height:100%;transition:width 1s linear}
    .session-warning{color:#f59e0b !important}
    .session-expired{color:#ef4444 !important}
    @media(max-width:880px){.wrap{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <div class="wrap">
    <section>
      <h1>Sign in / Sign up</h1>
      <div>
        <label for="email">Email</label>
        <input id="email" type="email" placeholder="you@example.com" />
        <label for="password">Password</label>
        <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        <div style="display:flex;gap:8px">
          <button id="btnSignIn">Sign in</button>
          <button id="btnSignUp">Create account</button>
        </div>
        <button id="btnSignOut" style="display:none;background:#ef4444;color:#fff">Sign out</button>
        <div class="hint">This example uses <strong>Supabase</strong> (free tier). Replace the PROJECT_URL and ANON_KEY at the top of the script with yours.</div>
      </div>
      <div class="small">Status: <span id="status">not signed in</span></div>
      
      <!-- Session Timer -->
      <div id="sessionTimer" class="session-timer" style="display:none">
        <span id="timerText">Session expires in 10:00</span>
        <div class="session-bar">
          <div id="sessionProgress" class="session-progress" style="width:100%"></div>
        </div>
      </div>
      
      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,.03)" />
      <div class="small">Notes:
        <ul style="margin:6px 0 0 18px;padding:0;color:var(--muted)">
          <li>Bucket in this example must be <strong>public</strong> so the client can get file URLs directly. For private files, you'll need a server-side signed URL generator (I can show that).</li>
          <li>Files are listed from the bucket called <code>files</code>. Create that in Supabase Storage.</li>
          <li><strong>Session expires after 10 minutes of inactivity</strong> - you'll need to sign in again for security.</li>
        </ul>
      </div>
    </section>

    <section>
      <div class="top-actions" style="justify-content:space-between;align-items:center">
        <div>
          <h1 style="font-size:18px">Files</h1>
          <div class="small" id="currentLocation">Browse folders to view files</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="search" type="text" placeholder="Search files by name" style="display:none" />
          <button id="btnRefresh">Refresh</button>
        </div>
      </div>

      <div id="breadcrumb" class="breadcrumb" style="display:none">
        <span id="backToRoot" onclick="navigateToFolder('')">üìÅ Root</span>
        <span id="currentPath"></span>
      </div>

      <div class="files" id="filesList">
        <!-- files will appear here -->
      </div>
    </section>
  </div>

  <!-- supabase-js CDN (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // -------------------- CONFIG --------------------
    const SUPABASE_URL = 'https://kplpwlfoyexfgfenewit.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbHB3bGZveWV4ZmdmZW5ld2l0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NzE0MDIsImV4cCI6MjA3MzI0NzQwMn0.tlp8K3OYGo2anGdiAi7iq9Yz-5O00sjGUIhC9vXjZjY';
    const STORAGE_BUCKET = 'files';
    
    // Session timeout configuration
    const SESSION_DURATION = 10 * 60 * 1000;
    
    // localStorage keys
    const SESSION_START_KEY = 'fileportal_session_start';
    const SESSION_ACTIVE_KEY = 'fileportal_session_active';
    const FOLDER_CACHE_KEY = 'fileportal_folder_cache';
    
    let sessionStartTime = null;
    let sessionTimeout = null;
    let sessionInterval = null;
    let folderCache = new Map();
    // ------------------------------------------------

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // State for folder navigation
    let currentPath = '';
    let allFolders = [];

    const $email = document.getElementById('email');
    const $password = document.getElementById('password');
    const $status = document.getElementById('status');
    const $btnSignIn = document.getElementById('btnSignIn');
    const $btnSignUp = document.getElementById('btnSignUp');
    const $btnSignOut = document.getElementById('btnSignOut');
    const $filesList = document.getElementById('filesList');
    const $search = document.getElementById('search');
    const $btnRefresh = document.getElementById('btnRefresh');
    const $breadcrumb = document.getElementById('breadcrumb');
    const $currentPath = document.getElementById('currentPath');
    const $currentLocation = document.getElementById('currentLocation');
    
    // Session timer elements
    const $sessionTimer = document.getElementById('sessionTimer');
    const $timerText = document.getElementById('timerText');
    const $sessionProgress = document.getElementById('sessionProgress');

    // FIXED: Proper URL generation for nested files
    function generateFileUrl(bucket, filePath) {
      try {
        // Split path into folder parts and filename
        const pathParts = filePath.split('/');
        const filename = pathParts.pop(); // Get filename
        const folderPath = pathParts.join('/'); // Get folder path
        
        console.log('Generating URL for:', {
          bucket,
          fullPath: filePath,
          folderPath,
          filename
        });
        
        // Use getPublicUrl with the full path
        const { data } = supabase.storage
          .from(bucket)
          .getPublicUrl(filePath);
        
        console.log('Generated URL:', data.publicUrl);
        return data.publicUrl;
      } catch (error) {
        console.error('Error generating file URL:', error);
        
        // Fallback: Manual URL construction with proper encoding
        const encodedPath = encodeURIComponent(filePath);
        const fallbackUrl = `${SUPABASE_URL}/storage/v1/object/public/${bucket}/${encodedPath}`;
        console.log('Using fallback URL:', fallbackUrl);
        return fallbackUrl;
      }
    }

    // Folder cache persistence helpers
    function loadFolderCacheFromStorage() {
      try {
        const saved = localStorage.getItem(FOLDER_CACHE_KEY);
        if (saved) {
          const cacheData = JSON.parse(saved);
          folderCache.clear();
          
          const oneHourAgo = Date.now() - (60 * 60 * 1000);
          for (const [normalizedName, timestamp] of Object.entries(cacheData)) {
            if (timestamp > oneHourAgo) {
              folderCache.set(normalizedName, timestamp);
            }
          }
          
          console.log(`Restored folder cache: ${folderCache.size} entries`);
        }
      } catch (err) {
        console.error('Failed to load folder cache from storage:', err);
      }
    }

    function saveFolderCacheToStorage() {
      try {
        const cacheData = {};
        for (const [key, timestamp] of folderCache.entries()) {
          cacheData[key] = timestamp;
        }
        localStorage.setItem(FOLDER_CACHE_KEY, JSON.stringify(cacheData));
      } catch (err) {
        console.error('Failed to save folder cache to storage:', err);
      }
    }

    // Session persistence helpers
    function saveSessionStartTime(timestamp) {
      try {
        localStorage.setItem(SESSION_START_KEY, timestamp.toString());
        localStorage.setItem(SESSION_ACTIVE_KEY, 'true');
      } catch (err) {
        console.error('Failed to save session to localStorage:', err);
      }
    }

    function loadSessionStartTime() {
      try {
        const saved = localStorage.getItem(SESSION_START_KEY);
        const isActive = localStorage.getItem(SESSION_ACTIVE_KEY) === 'true';
        
        if (saved && isActive) {
          const timestamp = parseInt(saved);
          const now = Date.now();
          const elapsed = now - timestamp;
          
          if (elapsed < SESSION_DURATION) {
            return timestamp;
          } else {
            clearSessionStorage();
          }
        }
      } catch (err) {
        console.error('Failed to load session from localStorage:', err);
      }
      
      return null;
    }

    function clearSessionStorage() {
      try {
        localStorage.removeItem(SESSION_START_KEY);
        localStorage.removeItem(SESSION_ACTIVE_KEY);
      } catch (err) {
        console.error('Failed to clear session storage:', err);
      }
    }

    function initializeSessionFromStorage() {
      sessionStartTime = loadSessionStartTime();
      
      if (sessionStartTime) {
        startSessionTimerFromStorage();
      } else {
        sessionStartTime = null;
      }
    }

    // Helper to normalize folder names
    function normalizeFolderName(name) {
      return name.replace(/\/$/, '').trim().toLowerCase();
    }

    function isFolderCached(folderName) {
      const normalized = normalizeFolderName(folderName);
      const cached = folderCache.get(normalized);
      
      if (cached) {
        const oneHourAgo = Date.now() - (60 * 60 * 1000);
        if (cached > oneHourAgo) {
          return true;
        } else {
          folderCache.delete(normalized);
          saveFolderCacheToStorage();
        }
      }
      
      return false;
    }

    function addFolderToCache(folderName) {
      const normalized = normalizeFolderName(folderName);
      folderCache.set(normalized, Date.now());
      saveFolderCacheToStorage();
    }

    function cleanFolderCache() {
      const oneHourAgo = Date.now() - (60 * 60 * 1000);
      let cleaned = 0;
      
      for (const [key, timestamp] of folderCache.entries()) {
        if (timestamp < oneHourAgo) {
          folderCache.delete(key);
          cleaned++;
        }
      }
      
      if (cleaned > 0) {
        saveFolderCacheToStorage();
      }
    }

    async function updateUiForUser(user) {
      if (!user) {
        cleanFolderCache();
      }
      
      if (user) {
        $status.textContent = `signed in as ${user.email}`;
        $btnSignOut.style.display = 'inline-block';
        $btnSignIn.style.display = 'none';
        $btnSignUp.style.display = 'none';
        $breadcrumb.style.display = 'block';
        $sessionTimer.style.display = 'block';
        
        if (!sessionStartTime) {
          sessionStartTime = Date.now();
          saveSessionStartTime(sessionStartTime);
          startSessionTimer();
        } else {
          updateSessionDisplay();
        }
        
        currentPath = '';
        await loadRootFolders();
      } else {
        $status.textContent = 'not signed in';
        $btnSignOut.style.display = 'none';
        $btnSignIn.style.display = 'inline-block';
        $btnSignUp.style.display = 'inline-block';
        $breadcrumb.style.display = 'none';
        $sessionTimer.style.display = 'none';
        $currentLocation.textContent = 'Browse folders to view files';
        $filesList.innerHTML = '<div class="meta">Sign in to see folders.</div>';
        currentPath = '';
        allFolders = [];
        
        sessionStartTime = null;
        stopSessionTimer();
        clearSessionStorage();
        folderCache.clear();
      }
    }

    function startSessionTimerFromStorage() {
      if (sessionTimeout) clearTimeout(sessionTimeout);
      if (sessionInterval) clearInterval(sessionInterval);
      
      const elapsed = Date.now() - sessionStartTime;
      const remaining = SESSION_DURATION - elapsed;
      
      if (remaining > 0) {
        sessionTimeout = setTimeout(() => {
          handleSessionExpiry();
        }, remaining);
        
        sessionInterval = setInterval(updateSessionDisplay, 1000);
        
        if (!document.hasSessionListeners) {
          document.addEventListener('click', resetSessionTimer);
          document.addEventListener('keypress', resetSessionTimer);
          document.addEventListener('mousemove', resetSessionTimer);
          document.hasSessionListeners = true;
        }
        
        updateSessionDisplay();
      } else {
        handleSessionExpiry();
      }
    }

    function startSessionTimer() {
      if (sessionTimeout && sessionInterval) {
        updateSessionDisplay();
        return;
      }
      
      if (sessionTimeout) clearTimeout(sessionTimeout);
      if (sessionInterval) clearInterval(sessionInterval);
      
      sessionTimeout = setTimeout(() => {
        handleSessionExpiry();
      }, SESSION_DURATION);
      
      sessionInterval = setInterval(updateSessionDisplay, 1000);
      
      if (!document.hasSessionListeners) {
        document.addEventListener('click', resetSessionTimer);
        document.addEventListener('keypress', resetSessionTimer);
        document.addEventListener('mousemove', resetSessionTimer);
        document.hasSessionListeners = true;
      }
      
      updateSessionDisplay();
    }

    function stopSessionTimer() {
      if (sessionTimeout) {
        clearTimeout(sessionTimeout);
        sessionTimeout = null;
      }
      if (sessionInterval) {
        clearInterval(sessionInterval);
        sessionInterval = null;
      }
    }

    function resetSessionTimer() {
      if (!sessionStartTime) return;
      
      saveSessionStartTime(sessionStartTime);
      
      clearTimeout(sessionTimeout);
      sessionTimeout = setTimeout(() => {
        handleSessionExpiry();
      }, SESSION_DURATION);
      
      updateSessionDisplay();
    }

    function updateSessionDisplay() {
      if (!sessionStartTime) return;
      
      const elapsed = Date.now() - sessionStartTime;
      const remaining = SESSION_DURATION - elapsed;
      const progress = Math.max(0, (remaining / SESSION_DURATION) * 100);
      
      if (remaining <= 0) {
        $timerText.textContent = 'Session expired - logging out...';
        $timerText.className = 'session-expired';
        $sessionProgress.style.width = '0%';
        clearSessionStorage();
        return;
      }
      
      const minutes = Math.floor(remaining / 60000);
      const seconds = Math.floor((remaining % 60000) / 1000);
      const timeText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      if (remaining <= 120000) {
        $timerText.className = 'session-warning';
        $timerText.textContent = `Session expires in ${timeText} ‚ö†Ô∏è`;
      } else {
        $timerText.className = '';
        $timerText.textContent = `Session expires in ${timeText}`;
      }
      
      $sessionProgress.style.width = `${progress}%`;
    }

    async function handleSessionExpiry() {
      sessionStartTime = null;
      clearSessionStorage();
      
      if (confirm('Your session has expired for security reasons. You will be logged out. Click OK to continue.')) {
        await supabase.auth.signOut();
      } else {
        await supabase.auth.signOut();
      }
    }

    // FIXED: Load root folders
    async function loadRootFolders() {
      $filesList.innerHTML = '<div class="meta">Loading folders...</div>';
      
      try {
        const { data, error } = await supabase.storage.from(STORAGE_BUCKET).list('', { limit: 1000 });
        if (error) {
          $filesList.innerHTML = '<div class="meta">Error loading folders: ' + error.message + '</div>';
          return;
        }
        
        if (!data || data.length === 0) {
          $filesList.innerHTML = '<div class="meta">No folders found. Create folders in Supabase Storage.</div>';
          return;
        }

        const seenFolders = new Set();
        allFolders = [];
        
        console.log('=== ROOT FOLDER SCAN ===');
        console.log('Raw root items:', data.map(item => item.name));
        
        for (const item of data) {
          const normalizedName = normalizeFolderName(item.name);
          
          console.log(`\nChecking: "${item.name}" -> normalized: "${normalizedName}"`);
          
          if (isFolderCached(item.name)) {
            console.log('  ‚Üí SKIPPED: Already in persistent cache');
            seenFolders.add(normalizedName);
            allFolders.push({ 
              name: normalizedName, 
              fullPath: normalizedName,
              originalName: item.name,
              isFolder: true 
            });
            continue;
          }
          
          if (seenFolders.has(normalizedName)) {
            console.log('  ‚Üí SKIPPED: Duplicate in current scan');
            continue;
          }
          
          let isFolder = false;
          
          if (item.name.endsWith('/')) {
            isFolder = true;
            console.log('  ‚Üí DETECTED: Explicit folder');
          } else {
            const { data: contents, error: checkError } = await supabase.storage
              .from(STORAGE_BUCKET)
              .list(item.name, { limit: 1 });
            
            const contentCount = contents ? contents.length : 0;
            console.log(`  ‚Üí Contents: ${contentCount} items`);
            
            if (!checkError && contentCount > 0) {
              isFolder = true;
              console.log('  ‚Üí DETECTED: Has contents (folder)');
            }
          }
          
          if (isFolder) {
            seenFolders.add(normalizedName);
            const displayName = normalizedName;
            allFolders.push({ 
              name: displayName, 
              fullPath: displayName,
              originalName: item.name,
              isFolder: true 
            });
            addFolderToCache(item.name);
            console.log(`  ‚Üí ADDED: Folder "${displayName}"`);
          }
        }

        console.log('Unique folders:', allFolders.map(f => f.name));

        if (allFolders.length === 0) {
          $filesList.innerHTML = '<div class="meta">No folders found. Create folders in Supabase Storage.</div>';
          return;
        }

        renderRootFolders(allFolders);
        updateBreadcrumb('');
      } catch (err) {
        console.error('Error detecting folders:', err);
        $filesList.innerHTML = '<div class="meta">Error loading folders.</div>';
      }
    }

    // FIXED: Navigate to folder
    window.navigateToFolder = async function(path) {
      currentPath = normalizeFolderName(path);
      console.log('Navigating to:', currentPath);
      await loadFolderContents(currentPath);
      updateBreadcrumb(currentPath);
    };

    // FIXED: Load folder contents with proper URL generation
    async function loadFolderContents(path) {
      $filesList.innerHTML = '<div class="meta">Loading folder contents...</div>';
      
      console.log('Loading contents of:', path);
      
      const cleanPath = normalizeFolderName(path);
      
      const { data, error } = await supabase.storage.from(STORAGE_BUCKET).list(cleanPath, { limit: 1000 });
      if (error) {
        $filesList.innerHTML = '<div class="meta">Error loading folder: ' + error.message + '</div>';
        console.error('Load folder error:', error);
        return;
      }
      
      console.log('Raw folder contents:', data?.map(item => item.name) || []);
      
      if (!data || data.length === 0) {
        $filesList.innerHTML = '<div class="meta">This folder is empty.</div>';
        return;
      }

      const seenItems = new Set();
      const folders = [];
      const files = [];
      
      for (const item of data) {
        const normalizedItemName = normalizeFolderName(item.name);
        
        console.log(`Processing: "${item.name}"`);
        
        if (seenItems.has(normalizedItemName)) {
          console.log('  ‚Üí SKIPPED: Duplicate');
          continue;
        }
        
        seenItems.add(normalizedItemName);
        
        if (item.name.endsWith('/')) {
          const folderName = normalizeFolderName(item.name);
          folders.push({ 
            name: folderName, 
            fullPath: `${cleanPath}/${folderName}` 
          });
          console.log('  ‚Üí ADDED: Subfolder');
        } else {
          const subfolderPath = `${cleanPath}/${item.name}`;
          const { data: contents } = await supabase.storage.from(STORAGE_BUCKET).list(subfolderPath, { limit: 1 });
          
          if (contents && contents.length > 0) {
            folders.push({ 
              name: item.name, 
              fullPath: subfolderPath 
            });
            console.log('  ‚Üí ADDED: Nested subfolder');
          } else {
            // FIXED: This is a file - generate proper URL
            const fullFilePath = `${cleanPath}/${item.name}`;
            
            // FIXED: Use the new URL generation function
            const publicUrl = generateFileUrl(STORAGE_BUCKET, fullFilePath);
            
            console.log(`  ‚Üí ADDED: File "${item.name}"`);
            console.log(`  ‚Üí Full path: "${fullFilePath}"`);
            console.log(`  ‚Üí Generated URL: "${publicUrl}"`);
            
            files.push({ 
              name: item.name, 
              fullPath: fullFilePath, 
              size: 0,
              publicUrl: publicUrl 
            });
          }
        }
      }

      console.log('Folders:', folders.map(f => f.name));
      console.log('Files:', files.map(f => f.name));

      renderFolderContents(folders, files, cleanPath);
    }

    function renderRootFolders(folders) {
      $filesList.innerHTML = '';
      
      if (folders.length === 0) {
        $filesList.innerHTML = '<div class="meta">No folders found. Create folders in Supabase Storage.</div>';
        return;
      }

      const folderCount = document.createElement('div');
      folderCount.style.cssText = 'padding:10px;border-bottom:1px solid rgba(255,255,255,.03);margin-bottom:10px;';
      folderCount.innerHTML = `<div style="font-weight:600;color:var(--accent)">üìÅ Folders (${folders.length})</div>`;
      $filesList.appendChild(folderCount);

      folders.forEach(folder => {
        const el = document.createElement('div');
        el.className = 'folder';
        el.innerHTML = `
          <div style="flex: 1;">
            <div style="font-weight:600">üìÅ ${escapeHtml(folder.name)}</div>
            <div class="meta">Folder</div>
          </div>
          <div class="actions">
            <span style="color:var(--muted);font-size:12px">Click to enter</span>
          </div>
        `;
        
        el.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          navigateToFolder(folder.fullPath);
        });
        
        el.querySelectorAll('*').forEach(child => {
          child.style.pointerEvents = 'none';
        });
        
        $filesList.appendChild(el);
      });
    }

    function renderFolderContents(folders, files, currentPath) {
      $filesList.innerHTML = '';

      const locationInfo = document.createElement('div');
      locationInfo.style.cssText = 'padding:10px;border-bottom:1px solid rgba(255,255,255,.03);margin-bottom:10px;';
      locationInfo.innerHTML = `<div style="font-weight:600;color:var(--accent)">üìÇ ${escapeHtml(currentPath)} (${files.length} files, ${folders.length} folders)</div>`;
      $filesList.appendChild(locationInfo);

      folders.forEach(folder => {
        const el = document.createElement('div');
        el.className = 'folder';
        el.innerHTML = `
          <div style="flex: 1;">
            <div style="font-weight:600">üìÅ ${escapeHtml(folder.name)}</div>
            <div class="meta">Folder</div>
          </div>
          <div class="actions">
            <span style="color:var(--muted);font-size:12px">Click to enter</span>
          </div>
        `;
        
        el.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          navigateToFolder(folder.fullPath);
        });
        
        el.querySelectorAll('*').forEach(child => {
          child.style.pointerEvents = 'none';
        });
        
        $filesList.appendChild(el);
      });

      // FIXED: Enhanced file rendering with URL validation
      files.forEach(it => {
        const el = document.createElement('div');
        el.className = 'file';
        
        // FIXED: Test the URL before rendering
        const testUrl = new URL(it.publicUrl);
        console.log(`Rendering file: "${it.name}" with URL: "${it.publicUrl}"`);
        
        el.innerHTML = `
          <div style="flex: 1;">
            <div style="font-weight:600">üìÑ ${escapeHtml(it.name)}</div>
            <div class="meta">File</div>
          </div>
          <div class="actions">
            <a href="${it.publicUrl}" target="_blank" rel="noopener noreferrer">Open</a>
          </div>
        `;
        
        // Add click handler with error handling
        el.querySelector('a').addEventListener('click', function(e) {
          console.log('File clicked:', it.name);
          console.log('Opening URL:', it.publicUrl);
          
          // Test if URL is valid before opening
          fetch(it.publicUrl, { method: 'HEAD' })
            .then(response => {
              if (response.ok) {
                console.log('URL is valid - opening file');
                window.open(it.publicUrl, '_blank');
              } else {
                console.error('URL returned status:', response.status);
                alert(`File not found: ${it.name}`);
              }
            })
            .catch(err => {
              console.error('URL fetch error:', err);
              alert(`Error accessing file: ${it.name}`);
            });
            
          e.preventDefault(); // Prevent default navigation
        });
        
        $filesList.appendChild(el);
      });
    }

    function updateBreadcrumb(path = '') {
      if (!path) {
        $currentLocation.textContent = 'Browse folders to view files';
        $currentPath.innerHTML = '';
        document.getElementById('backToRoot').textContent = 'üìÅ Root';
        return;
      }

      $currentLocation.textContent = `Inside: ${path}`;
      
      const parts = path.split('/').filter(p => p);
      let breadcrumbHtml = '';
      let accumPath = '';
      
      parts.forEach((part, i) => {
        accumPath += part + '/';
        if (i === parts.length - 1) {
          breadcrumbHtml += `<span>${escapeHtml(part)}</span>`;
        } else {
          breadcrumbHtml += `<span onclick="navigateToFolder('${accumPath.slice(0, -1)}')">${escapeHtml(part)}</span> > `;
        }
      });
      
      $currentPath.innerHTML = breadcrumbHtml;
      document.getElementById('backToRoot').textContent = 'üìÅ Root';
    }

    $btnRefresh.addEventListener('click', () => {
      console.log('Button refresh clicked');
      if (currentPath === '') {
        loadRootFolders();
      } else {
        loadFolderContents(currentPath);
      }
    });

    function escapeHtml(s) {
      return s.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
    }

    // Page load initialization
    window.addEventListener('load', () => {
      console.log('=== PAGE LOAD INITIATED ===');
      
      // 1. Load persistent folder cache
      loadFolderCacheFromStorage();
      
      // 2. Restore session
      initializeSessionFromStorage();
      
      // 3. Load Supabase auth
      supabase.auth.getSession().then(({ data: { session } }) => {
        console.log('Supabase session loaded:', session?.user?.email || 'No user');
        updateUiForUser(session?.user || null);
      });

      supabase.auth.onAuthStateChange((event, session) => {
        updateUiForUser(session?.user || null);
      });

      console.log('Page initialization complete');
    });

    // Event listeners
    $btnSignIn.addEventListener('click', async () => {
      const email = $email.value.trim();
      const password = $password.value;
      if (!email || !password) return alert('Enter email and password');
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return alert('Sign in error: ' + error.message);
    });

    $btnSignUp.addEventListener('click', async () => {
      const email = $email.value.trim();
      const password = $password.value;
      if (!email || !password) return alert('Enter email and password');
      const { data, error } = await supabase.auth.signUp({ email, password });
      if (error) return alert('Sign up error: ' + error.message);
      else alert('Check your email to confirm (if required by your Supabase settings).');
    });

    $btnSignOut.addEventListener('click', async () => {
      console.log('Manual sign out clicked');
      await supabase.auth.signOut();
      $email.value = '';
      $password.value = '';
    });

    // Initialize
    console.log('Script loaded - waiting for DOM...');
  </script>
</body>
</html>
