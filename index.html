<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Supabase File Portal</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .hidden { display: none; }
    button { margin: 5px; padding: 5px 10px; }
    #file-list li { margin: 4px 0; }
    .progress-container { margin: 10px 0; }
    .progress-bar { height: 10px; background: green; width: 0%; transition: width 1s linear; }
    .file-actions button { margin-left: 10px; }
  </style>
</head>
<body>
  <h2>Supabase File Portal</h2>

  <div id="auth-section">
    <input id="email" type="email" placeholder="Email"><br>
    <input id="password" type="password" placeholder="Password"><br>
    <button onclick="signIn()">Sign In</button>
    <button onclick="signUp()">Sign Up</button>
  </div>

  <div id="portal-section" class="hidden">
    <button onclick="signOut()">Sign Out</button>
    <div id="session-warning" class="hidden">
      <p>Session will expire soon! Stay active.</p>
      <div class="progress-container">
        <div id="progress-bar" class="progress-bar"></div>
      </div>
    </div>
    <h3>Files</h3>
    <div id="breadcrumb"></div>
    <ul id="file-list"></ul>
  </div>

  <script>
    // ---------------- Supabase Config ----------------
    const SUPABASE_URL = "https://kplpwlfoyexfgfenewit.supabase.co"; // ðŸ”„ replace with your project
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbHB3bGZveWV4ZmdmZW5ld2l0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NzE0MDIsImV4cCI6MjA3MzI0NzQwMn0.tlp8K3OYGo2anGdiAi7iq9Yz-5O00sjGUIhC9vXjZjY"; // ðŸ”„ replace with your anon key
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const BUCKET = "files";
    const CACHE_KEY = "fileportal_folder_cache";
    const SESSION_TIMEOUT = 10 * 60 * 1000; // 10 minutes
    const SIGNED_URL_TTL = 60; // 60 seconds

    let currentPath = "";
    let sessionTimer, progressInterval, remainingTime;

    // ---------------- Auth ----------------
    async function signIn() {
      const { data, error } = await supabase.auth.signInWithPassword({
        email: document.getElementById("email").value,
        password: document.getElementById("password").value,
      });
      if (error) return alert(error.message);
      document.getElementById("auth-section").classList.add("hidden");
      document.getElementById("portal-section").classList.remove("hidden");
      resetSessionTimer();
      listFiles();
    }

    async function signUp() {
      const { error } = await supabase.auth.signUp({
        email: document.getElementById("email").value,
        password: document.getElementById("password").value,
      });
      if (error) alert(error.message);
      else alert("Check your email to confirm registration.");
    }

    async function signOut() {
      await supabase.auth.signOut();
      document.getElementById("auth-section").classList.remove("hidden");
      document.getElementById("portal-section").classList.add("hidden");
      stopSessionTimer();
    }

    // ---------------- Session Timer ----------------
    function resetSessionTimer() {
      stopSessionTimer();
      remainingTime = SESSION_TIMEOUT;
      sessionTimer = setInterval(() => {
        remainingTime -= 1000;
        updateProgressBar();
        if (remainingTime <= 0) {
          clearInterval(sessionTimer);
          alert("Session expired, logging out.");
          signOut();
        }
      }, 1000);
    }

    function stopSessionTimer() {
      clearInterval(sessionTimer);
      clearInterval(progressInterval);
      document.getElementById("session-warning").classList.add("hidden");
    }

    function updateProgressBar() {
      const warning = document.getElementById("session-warning");
      const bar = document.getElementById("progress-bar");
      if (remainingTime <= 60 * 1000) {
        warning.classList.remove("hidden");
        const percent = (remainingTime / 60000) * 100;
        bar.style.width = percent + "%";
      } else {
        warning.classList.add("hidden");
      }
    }

    // ---------------- File Browser ----------------
    async function listFiles(path = "") {
      currentPath = path;

      const { data, error } = await supabase.storage
        .from(BUCKET)
        .list(path, { limit: 100, offset: 0 });

      if (error) return alert(error.message);

      renderBreadcrumb();
      const list = document.getElementById("file-list");
      list.innerHTML = "";

      data.forEach((item) => {
        const li = document.createElement("li");
        if (item.metadata) {
          // File
          li.textContent = item.name;
          const actions = document.createElement("span");
          actions.className = "file-actions";

          const openBtn = document.createElement("button");
          openBtn.textContent = "ðŸ‘ï¸ Open";
          openBtn.onclick = () => openFile(path + (path ? "/" : "") + item.name);
          actions.appendChild(openBtn);

          const dlBtn = document.createElement("button");
          dlBtn.textContent = "â¬‡ï¸ Download";
          dlBtn.onclick = () => downloadFile(path + (path ? "/" : "") + item.name);
          actions.appendChild(dlBtn);

          li.appendChild(actions);
        } else {
          // Folder
          const btn = document.createElement("button");
          btn.textContent = "ðŸ“‚ " + item.name;
          btn.onclick = () => listFiles(path + (path ? "/" : "") + item.name);
          li.appendChild(btn);
        }
        list.appendChild(li);
      });
    }

    function renderBreadcrumb() {
      const container = document.getElementById("breadcrumb");
      container.innerHTML = "";
      const parts = currentPath.split("/").filter(Boolean);
      let accum = "";
      const rootBtn = document.createElement("button");
      rootBtn.textContent = "ðŸ  Root";
      rootBtn.onclick = () => listFiles("");
      container.appendChild(rootBtn);

      parts.forEach((p, i) => {
        accum += (i > 0 ? "/" : "") + p;
        const btn = document.createElement("button");
        btn.textContent = p;
        btn.onclick = () => listFiles(parts.slice(0, i + 1).join("/"));
        container.appendChild(btn);
      });
    }

    // ---------------- File Actions ----------------
    async function openFile(filePath) {
      const { data, error } = await supabase.storage
        .from(BUCKET)
        .createSignedUrl(filePath, SIGNED_URL_TTL);

      if (error) return alert("Open failed: " + error.message);
      window.open(data.signedUrl, "_blank");
    }

    async function downloadFile(filePath) {
      const { data, error } = await supabase.storage
        .from(BUCKET)
        .download(filePath);

      if (error) return alert("Download failed: " + error.message);

      const blob = data;
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filePath.split("/").pop();
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
