<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supabase Storage Browser</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    .hidden { display: none; }
    button { padding: 8px 12px; margin: 5px; cursor: pointer; }
    .file-list { list-style: none; padding: 0; }
    .file-list li { padding: 10px; border-bottom: 1px solid #eee; }
    .folder { background: #f0f8ff; cursor: pointer; color: blue; }
    .folder:hover { background: #e6f3ff; }
    .file { color: green; }
    .file a { text-decoration: none; color: inherit; }
    .breadcrumb { margin: 10px 0; }
    .breadcrumb span { cursor: pointer; color: blue; margin-right: 5px; }
    .breadcrumb span:hover { text-decoration: underline; }
    #status { margin: 10px 0; color: #666; }
  </style>
</head>
<body>
  <!-- Your existing HTML structure -->
  <div id="auth">
    <h3>Sign in / Sign up</h3>
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Password" />
    <button id="signIn">Sign in</button>
    <button id="createAccount">Create account</button>
    <button id="signOut" class="hidden">Sign out</button>
    <p>This example uses Supabase (free tier). Replace the PROJECT_URL and ANON_KEY at the top of the script with yours.</p>
  </div>

  <div id="status">Status: not signed in</div>

  <div class="notes">
    <p>Notes:</p>
    <ul>
      <li>Bucket in this example must be public so the client can get file URLs directly. For private files, you'll need a server-side signed URL generator (I can show that).</li>
      <li>Files are listed from the bucket called files. Create that in Supabase Storage.</li>
    </ul>
  </div>

  <div id="fileBrowser" class="hidden">
    <h3>Files</h3>
    <p>Browse files available to authenticated users</p>
    <button id="refresh">Refresh</button>
    <div id="breadcrumb" class="breadcrumb"></div>
    <ul id="fileList" class="file-list"></ul>
  </div>

  <script>
    // Update with your Supabase config
    const PROJECT_URL = 'https://your-project.supabase.co'; // Replace
    const ANON_KEY = 'your-anon-key'; // Replace

    const supabase = Supabase.createClient(PROJECT_URL, ANON_KEY);

    let currentPath = ''; // Track current folder path

    // Auth handlers
    document.getElementById('signIn').addEventListener('click', async () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) alert(error.message);
      else updateUI();
    });

    document.getElementById('createAccount').addEventListener('click', async () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const { error } = await supabase.auth.signUp({ email, password });
      if (error) alert(error.message);
    });

    document.getElementById('signOut').addEventListener('click', async () => {
      await supabase.auth.signOut();
      updateUI();
    });

    // File browser handlers
    document.getElementById('refresh').addEventListener('click', () => loadFiles(currentPath));

    async function updateUI() {
      const { data: { session } } = await supabase.auth.getSession();
      const status = document.getElementById('status');
      const auth = document.getElementById('auth');
      const signOut = document.getElementById('signOut');
      const fileBrowser = document.getElementById('fileBrowser');

      if (session) {
        status.textContent = `Status: signed in as ${session.user.email}`;
        auth.classList.add('hidden');
        signOut.classList.remove('hidden');
        fileBrowser.classList.remove('hidden');
        loadFiles(currentPath); // Load root on sign-in
      } else {
        status.textContent = 'Status: not signed in';
        auth.classList.remove('hidden');
        signOut.classList.add('hidden');
        fileBrowser.classList.add('hidden');
      }
    }

    async function loadFiles(path) {
      const { data, error } = await supabase.storage.from('files').list(path, { limit: 100 });
      if (error) {
        alert(`Error loading files: ${error.message}`);
        return;
      }

      // Render breadcrumb
      renderBreadcrumb(path);

      // Render list
      const fileList = document.getElementById('fileList');
      fileList.innerHTML = '';
      data.forEach(item => {
        const li = document.createElement('li');
        if (item.name.endsWith('/')) {
          // Folder
          li.classList.add('folder');
          li.textContent = `[FOLDER] ${item.name.slice(0, -1)}`;
          li.onclick = () => navigateToFolder(path ? `${path}${item.name}` : item.name);
        } else {
          // File
          li.classList.add('file');
          const url = supabase.storage.from('files').getPublicUrl(`${path}${item.name}`).data.publicUrl;
          const a = document.createElement('a');
          a.href = url;
          a.target = '_self'; // Open in same tab (prevents new tab)
          a.textContent = `[FILE] ${item.name} (${(item.metadata?.size || 0) / 1024} KB)`;
          a.download = item.name; // Fallback to download if not previewable
          li.appendChild(a);
        }
        fileList.appendChild(li);
      });
    }

    function navigateToFolder(newPath) {
      currentPath = newPath;
      loadFiles(currentPath);
    }

    function renderBreadcrumb(path) {
      const breadcrumb = document.getElementById('breadcrumb');
      if (!path) {
        breadcrumb.innerHTML = '<strong>Root</strong>';
        return;
      }

      // Simple split by '/' (assumes no spaces/special chars)
      const parts = path.split('/').filter(p => p);
      let html = '<span onclick="navigateToFolder(\'\')">Root</span>';
      let accumPath = '';
      parts.forEach((part, i) => {
        accumPath += part + '/';
        html += ` > <span onclick="navigateToFolder('${accumPath}')">${part}</span>`;
      });
      breadcrumb.innerHTML = html;
    }

    // Init on load
    updateUI();
    supabase.auth.onAuthStateChange(updateUI);
  </script>
</body>
</html>
